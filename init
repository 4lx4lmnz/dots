#!/bin/bash

# Initalization script which will do a few things:
#
#  1. Move the cloned directory into $HOME/.local/etc
#  2. Link the dots executable into $HOME/.local/bin
#  3. Add the $HOME/.local/bin directory to the $PATH if it isn't already
#  4. Source the base/bash/completion.d/dots completion script
#
# This script MUST be sourced!

if [[ $_ == $0 ]];
then
	echo "Please source me!"
	exit 1
fi

__dots_init()
{
	local arrow_bad="\033[0;31m==>\033[0m"
	local arrow_good="\033[0;32m==>\033[0m"
	local arrow_warn="\033[0;33m==>\033[0m"

	# The installation directory
	local install_dir="$HOME/.local/etc"

	# The directory that we just (presumably) cloned this into
	local cloned_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

	# The directory where the user keeps his executables
	local bin_dir="$HOME/.local/bin"

	# 1. Move everything into the install directory if we need to
	if [[ "$install_dir" != "$cloned_dir" ]]
	then
		# Make sure the installation directory isn't in use
		if [ -e "$install_dir" ] && ! find "$install_dir" -maxdepth 0 -empty | read v
		then
			echo -e "$arrow_bad $install_dir directory not empty"
			return
		fi

		# Move everything over
		echo -e "$arrow_good Moving $cloned_dir to $install_dir"

		# We need to create the directory tree but then remove just the install
		# directory so we can rename the cloned directory as the install
		# directory. If we don't remove the installed directory the cloned
		# directory will be placed inside of the install directory.
		mkdir -p "$install_dir"
		rm -rf "$install_dir"
		mv -f  "$cloned_dir" "$install_dir"

		# Get out of the empty directory if we were in it
		[[ "$(pwd)" == "$cloned_dir" ]] && cd
	fi

	# 2. Link the dots script into the users local bin
	if [[ ! -e "$bin_dir/dots" ]]
	then
		echo -e "$arrow_good Linking $install_dir/dots into $bin_dir"
		mkdir -p "$bin_dir"
		ln -s "$install_dir/dots" "$bin_dir/"

	# If the dots file already exists in bin check if it's not the same
	elif [[ "$(readlink "$bin_dir/dots")" != "$install_dir/dots" ]]
	then
		echo -e "$arrow_warn $bin_dir/dots already exists!"
	fi

	# 3. Add the bin directory to the front of the path
	if [[ ":$PATH:" != *":$bin_dir:"* ]]
	then
		echo -e "$arrow_good Temporarily adding $bin_dir to your PATH"
		PATH="$HOME/.local/bin:$PATH"
	fi

	# 4. Source in the dots completion
	if ! type -t __dots_completions | grep -q '^function$' 2>/dev/null
	then
		echo -e "$arrow_good Sourcing bash completions for dots"
		source "$install_dir/base/bash/completion.d/dots"
	fi

	echo -e "$arrow_good Dot files ready to be installed!"
}

__dots_init
unset -f __dots_init
